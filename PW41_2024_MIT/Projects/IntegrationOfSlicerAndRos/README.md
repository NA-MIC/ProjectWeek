---
layout: pw41-project

permalink: /:path/

project_title: Integration of Slicer and ROS
category: IGT and Training
presenter_location: In-person

key_investigators:

- name: Junichi Tokuda
  affiliation: BWH

- name: Anton Deguet
  affiliation: JHU

- name: Steve Pieper
  affiliation: Isomics

- name: Mariana Bernardes
  affiliation: BWH

- name: Laura Connolly
  affiliation: Queen's University

- name: Simon Leonard
  affiliation: JHU

---

# Project Description

SlicerROS2 is an extension that enables direct communication between the Robot Operating System 2 (ROS2) and 3D Slicer. The ROS is a set of software libraries and tools for building robot applications. ROS2 has been developed and distrubted using an open-source model and widely used in the robotics community. The goal of SlicerROS2 is to facilitate the integration of 3D Slicer and ROS to build systems for image-guided robot-assisted intervention. 

SlicerROS2 provides UI and API to communicate with other ROS nodes through Data Distribution Service (DDS), the publish-subscribe data transport middleware used in ROS2, allowing 3D Slicer to sychnonize its scen graph (MRML) with ROS's [tf](https://wiki.ros.org/tf2). It also has an interface to load a visual model of the robot onto the Slicer scene from robot description data in the URDF format published on the ROS system. 

## Objective

The objectives of this project are as follows:
1. **Improve existing implementation based on feedback from Slicer experts.** We will discuss use-cases with current and potential users in the community.
2. **Explore options for binary distribution.** Since the module must be built against 3D Slicer with system SSL and specific versions of ROS2, it is not possible to be built as part of the nightly build process.


## Approach and Plan

Questions discuss during the week:
- Questions of future use
  - Limited to robots or anything with a ROS2 interface (e.g. haptic devices, IMU, optical and magnetic trackers…)
  - Other software packages: [Gazebo](https://gazebosim.org/home), [AMBF](https://github.com/WPI-AIM/ambf), US/CT/MRI simulators…

- Detailed questions
  - Is multithreading possible?  Any other way to trigger a periodic computing task (now using QtTimer)
  - vtkObjects all have a name and timestamp.  Is the name used in Slicer?  Can we have a timestamp that is not a counter?
  - Improving unit testing, we have some but implementation seems clunky
  - For binary distributions, is there a way to host build and/or tgz files?  I can host build on JHU computers.
  - Is there an existing way to document code in modules, e.g. doxygen
  - Small issues: QLatinString in 2 places breaks compiling on older Qt and likely useless, some missing const


## Progress and Next Steps

<!-- Update this section as you make progress, describing of what you have ACTUALLY DONE.
     If there are specific steps that you could not complete then you can describe them here, too. -->

1. Coding
   1. Fixed a few issues based on Slicer experts in the room
      1. We use a Qt timer to "spin" the ROS node.  The timer was instantiated in the qLogicWidget and didn't spin until the user would select the ROS2 module.  We moved it to qLogic so it's always running.
      1. Fixed CMake project name conflicts between ROS and Slicer macros so the build is in `slicer_ros2_module` (snake_case for TROS) but the module name is `ROS2`
      1. Fixed issue with tests turning off errors and warnings for everything
   1. Code generation
      1. Finished CMake macros to call code generator as well as code generated by CMake itself
      1. Fixed code generation so vtk Python wrappers work (using simpler types `int` vs `int32_t`)
      1. Some simplification in code generator
   1. Usability
      1. Allow to create subscribers and publishers using short names, i.e. `String` vs `vtkMRMLROS2PublisherStringNode`
      1. Added method to list all existing publishers and subscribers
      1. When user tries to create a publisher or subscriber with invalid name, display list of option (good for typos)
      1. Publishers and subscribers now have method `GetBlankMessage` so it's easier to create a payload in Python
      1. Create a self-contained ROS2 package for US similuator in Gazebo that builds a minimal version of PlusLib/IGSIO/vtkAddon that contains launch models and launch files to teleoperate a UR-5 mounted with a US probe. 
1. Discussions
   1. Possible feature requests for Slicer
      1. Saved history in Python interpreter (like iPython)
      1. Time stamps in MRML nodes or vtk Object, as in `std::chrono`.  Very useful for realtime applications or anything intro-operative.  Most ROS payloads have timestamps.  This could be either set automatically (in `SetModified`) or controlled by user to preserve time of data collection.
   1. Distribution(s), pros and cons from user perspective
      1. Continue as-is, i.e. source code and users have to compile the module.  Pros: can add new messages.  Cons: have to compile Slicer from scratch, extensions are not available to download from kitware servers.
      1. Binary distribution with ROS2 core libraries added to Slicer super build.  Pros: ready to use, might even provide ROS2 support from Windows, MacOS, any linux instead of Ubuntu only.  Cons: harder to add custom messages without a compiler
      1. Binary (bis).  If we figure out how to "super build" ROS2 core libraries (`rclcpp`), why not provide the Python wrappers too (`rclpy`) as a pip build.  At that point, could port existing features from C++ to Python.  A ROS2 pip build could be used outside Slicer.
      1. Simulate and evaluate US/Robot hand-eye calibration by inserting probe in the simulated image and then compare results to ground-truth from the simulation. Adding reference 3D markers to make the simulation more relevant to clinical applications.
1. Next steps
   1. Investigate simple options to make source based distribution easier: provide Slicer and Slicer-SuperBuild, document how to compile and add extensions
   1. For any binary distribution, how hard would it be to compile all ROS2 dependencies from source for "super-building" or "piping" them
      
# Illustrations

<!-- Add pictures and links to videos that demonstrate what has been accomplished. -->


_No response_



# Background and References

<!-- If you developed any software, include link to the source code repository.
     If possible, also add links to sample data, and to any relevant publications. -->


_No response_

